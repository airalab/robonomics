name: Runtime Benchmarks

on:
  push:
    branches:
      - 'feat/*'
      - 'release/*'
  pull_request:
    branches:
      - 'feat/*'
      - 'release/*'

permissions:
  contents: read

jobs:
  benchmark-check:
    runs-on: ubuntu-latest
    steps:
      - name: Aggressive cleanup
        run: |
          # Remove Java (JDKs)
          sudo rm -rf /usr/lib/jvm
          # Remove .NET SDKs
          sudo rm -rf /usr/share/dotnet
          # Remove Swift toolchain
          sudo rm -rf /usr/share/swift
          # Remove Haskell (GHC)
          sudo rm -rf /usr/local/.ghcup
          # Remove Julia
          sudo rm -rf /usr/local/julia*
          # Remove Android SDKs
          sudo rm -rf /usr/local/lib/android
          # Remove Chromium
          sudo rm -rf /usr/local/share/chromium
          # Remove Microsoft/Edge and Google Chrome builds
          sudo rm -rf /opt/microsoft /opt/google
          # Remove Azure CLI
          sudo rm -rf /opt/az
          # Remove PowerShell
          sudo rm -rf /usr/local/share/powershell
          # Remove CodeQL and other toolcaches
          sudo rm -rf /opt/hostedtoolcache
          docker system prune -af || true
          docker builder prune -af || true
          df -h

      - name: Checkout the source code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-25.11
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: robonomics
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Test benchmarking devshell
        run: nix develop .#benchmarking --command bash -c "echo OK"

      - name: Run benchmark checks on representative pallets
        run: |
          nix develop .#benchmarking --command bash -c '
            set -e
            
            # Build runtime with benchmarking features
            echo "Building runtime with benchmarking features..."
            cargo build --release --features runtime-benchmarks -p robonomics-runtime --locked
            
            # Verify runtime WASM exists
            RUNTIME="./target/release/wbuild/robonomics-runtime/robonomics_runtime.compact.compressed.wasm"
            if [ ! -f "$RUNTIME" ]; then
              echo "Error: Runtime WASM not found at $RUNTIME"
              exit 1
            fi
            echo "Runtime WASM found at $RUNTIME"
            
            # Test a representative subset of pallets to verify benchmarking works
            # We use minimal steps/repeats for faster CI execution
            TEMPLATE="./scripts/weights/frame-weight-template.hbs"
            
            echo "Testing pallet_robonomics_datalog..."
            frame-omni-bencher v1 benchmark pallet \
              --runtime "$RUNTIME" \
              --pallet pallet_robonomics_datalog \
              --extrinsic "*" \
              --steps 2 \
              --repeat 1 \
              --output /tmp/weights_test_datalog.rs \
              --template "$TEMPLATE" \
              --header ./LICENSE
            
            echo "Testing pallet_balances (system pallet)..."
            frame-omni-bencher v1 benchmark pallet \
              --runtime "$RUNTIME" \
              --pallet pallet_balances \
              --extrinsic "*" \
              --steps 2 \
              --repeat 1 \
              --output /tmp/weights_test_balances.rs \
              --template "$TEMPLATE" \
              --header ./LICENSE
            
            echo "Testing pallet_xcm..."
            frame-omni-bencher v1 benchmark pallet \
              --runtime "$RUNTIME" \
              --pallet pallet_xcm \
              --extrinsic "*" \
              --steps 2 \
              --repeat 1 \
              --output /tmp/weights_test_xcm.rs \
              --template "$TEMPLATE" \
              --header ./LICENSE
            
            # Verify generated weights files
            for test_file in /tmp/weights_test_*.rs; do
              if [ ! -f "$test_file" ]; then
                echo "Error: Benchmark did not generate weights file: $test_file"
                exit 1
              fi
            done
            
            echo "All benchmark checks passed successfully!"
            echo "Sample weights file preview:"
            head -20 /tmp/weights_test_datalog.rs
          '

